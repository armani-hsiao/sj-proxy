<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SJ ä»£è³¼ç³»çµ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Cinzel:wght@400;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink:       #060a14;
  --navy-deep: #0a0f1e;
  --navy:      #0e1628;
  --navy-mid:  #162040;
  --navy-up:   #1e2d57;
  --border:    rgba(45,79,212,0.25);
  --border2:   rgba(75,107,232,0.50);
  --glow:      rgba(45,79,212,0.35);
  --glow-sm:   rgba(45,79,212,0.15);
  --royal:     #2d4fd4;
  --royal-lt:  #4a6be8;
  --sky:       #6b8ef0;
  --sky-lt:    #96aefd;
  --gold:      #e8c86a;
  --gold-lt:   #f5dfa0;
  --gold-dim:  rgba(232,200,106,0.12);
  --gold-glow: rgba(232,200,106,0.3);
  --text:      #dde4f8;
  --text2:     #8a9bca;
  --text3:     #4a5882;
  --text4:     #2e3a5e;
  --green:     #4ade80;
  --red:       #f87171;
  --red-dim:   rgba(248,113,113,0.12);
  --r: 10px; --r-lg: 16px; --r-xl: 22px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans TC',sans-serif;background:var(--ink);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 20% -10%,rgba(45,79,212,.18) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 90% 110%,rgba(45,79,212,.12) 0%,transparent 55%);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;inset:0;background-image:radial-gradient(circle,rgba(150,174,253,.3) 1px,transparent 1px),radial-gradient(circle,rgba(150,174,253,.12) 1px,transparent 1px);background-size:80px 80px,37px 37px;background-position:0 0,40px 40px;pointer-events:none;z-index:0;opacity:.3;mask-image:radial-gradient(ellipse 100% 100% at 50% 50%,black 30%,transparent 100%)}
.screen{display:none;position:relative;z-index:1}
.screen.active{display:block}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{display:none;min-height:100vh;align-items:center;justify-content:center;position:relative;z-index:1}
#login-screen.active{display:flex}
.login-wrap{width:400px;padding:48px 44px;background:linear-gradient(145deg,rgba(22,32,64,.95),rgba(14,22,40,.98));border:1px solid var(--border2);border-radius:var(--r-xl);box-shadow:0 0 0 1px rgba(255,255,255,.04),0 0 60px rgba(45,79,212,.3),0 40px 80px rgba(0,0,0,.7);animation:loginReveal .5s cubic-bezier(.22,1,.36,1) both;position:relative;overflow:hidden}
.login-wrap::before{content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:200px;height:120px;background:radial-gradient(ellipse,rgba(45,79,212,.5),transparent 70%);pointer-events:none}
.login-crest{text-align:center;margin-bottom:36px}
.crest-ring{display:inline-flex;align-items:center;justify-content:center;width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,rgba(45,79,212,.4),rgba(107,142,240,.15));border:1px solid var(--border2);margin-bottom:14px;box-shadow:0 0 24px var(--glow);font-size:28px;position:relative}
.crest-ring::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:1px solid rgba(150,174,253,.15)}
.login-title{font-family:'Cinzel',serif;font-size:22px;font-weight:700;letter-spacing:.12em;color:var(--sky-lt);display:block}
.login-sub{font-size:11px;letter-spacing:.25em;color:var(--text3);margin-top:5px;text-transform:uppercase;display:block}
.login-sect{font-size:10px;font-weight:600;letter-spacing:.18em;color:var(--text3);text-transform:uppercase;margin-bottom:10px;display:block;font-family:'DM Mono',monospace}
.user-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.user-btn{padding:11px 8px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:var(--r);color:var(--text2);font-family:'Noto Sans TC',sans-serif;font-size:13px;cursor:pointer;transition:all .15s;text-align:center;letter-spacing:.04em}
.user-btn:hover{background:rgba(45,79,212,.15);border-color:var(--border2);color:var(--text)}
.user-btn.selected{background:rgba(45,79,212,.25);border-color:var(--royal-lt);color:var(--sky-lt);box-shadow:0 0 14px var(--glow-sm),inset 0 1px 0 rgba(255,255,255,.08)}
.user-btn.admin-btn{grid-column:1/-1;background:var(--gold-dim);border-color:rgba(232,200,106,.2);color:var(--gold)}
.user-btn.admin-btn:hover,.user-btn.admin-btn.selected{background:rgba(232,200,106,.18);border-color:var(--gold);box-shadow:0 0 14px var(--gold-glow)}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,var(--royal),var(--royal-lt));color:#fff;border:none;border-radius:var(--r);font-family:'Noto Sans TC',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:22px;letter-spacing:.1em;box-shadow:0 4px 20px var(--glow);position:relative;overflow:hidden}
.btn-login::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.12) 100%)}
.btn-login:hover:not(:disabled){box-shadow:0 4px 32px rgba(45,79,212,.55);transform:translateY(-1px)}
.btn-login:disabled{opacity:.35;cursor:default;transform:none}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:58px;background:rgba(6,10,20,.9);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
.topbar-l{display:flex;align-items:center;gap:14px}
.wordmark{font-family:'Cinzel',serif;font-size:16px;font-weight:700;letter-spacing:.12em;color:var(--sky-lt);display:flex;align-items:center;gap:8px}
.wordmark span{font-size:18px}
.tdiv{width:1px;height:20px;background:var(--border)}
.user-chip{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;padding:3px 10px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:20px;letter-spacing:.06em}
.chip-dot{width:6px;height:6px;border-radius:50%;background:var(--royal-lt);box-shadow:0 0 6px var(--royal-lt);animation:pulseDot 2s infinite}
.chip-dot.gold{background:var(--gold);box-shadow:0 0 6px var(--gold)}
.topbar-r{display:flex;align-items:center;gap:10px}
.cart-btn{display:flex;align-items:center;gap:7px;padding:7px 16px;background:rgba(22,32,64,.7);border:1px solid var(--border);border-radius:var(--r);color:var(--text2);cursor:pointer;font-size:13px;font-family:'Noto Sans TC',sans-serif;transition:all .15s;position:relative}
.cart-btn:hover{background:rgba(45,79,212,.2);border-color:var(--border2);color:var(--sky-lt)}
.cart-badge{position:absolute;top:-7px;right:-7px;background:linear-gradient(135deg,var(--royal),var(--royal-lt));color:#fff;font-size:10px;font-weight:700;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;box-shadow:0 0 8px var(--glow)}
.cart-badge.hidden{display:none}
.logout-btn{padding:6px 13px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text3);cursor:pointer;font-size:12px;font-family:'Noto Sans TC',sans-serif;transition:all .15s}
.logout-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:2px;padding:16px 24px 0;border-bottom:1px solid var(--border);position:sticky;top:58px;background:rgba(6,10,20,.97);backdrop-filter:blur(8px);z-index:90}
.tab{padding:9px 20px;background:transparent;border:1px solid transparent;border-bottom:none;border-radius:8px 8px 0 0;color:var(--text3);cursor:pointer;font-size:13px;font-family:'Noto Sans TC',sans-serif;transition:all .15s;position:relative;bottom:-1px;letter-spacing:.04em}
.tab:hover{color:var(--text2)}
.tab.active{background:rgba(14,22,40,.98);border-color:var(--border);color:var(--sky-lt);border-bottom-color:rgba(14,22,40,.98)}

/* â”€â”€ MAIN â”€â”€ */
.main{padding:28px 24px;max-width:1140px;margin:0 auto}

/* â”€â”€ EVENT CARDS â”€â”€ */
.events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:18px}
.event-card{background:linear-gradient(145deg,rgba(22,32,64,.7),rgba(14,22,40,.85));border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden;cursor:pointer;transition:all .22s;position:relative}
.event-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--royal-lt),transparent);opacity:0;transition:opacity .2s}
.event-card:hover{border-color:var(--border2);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.45),0 0 0 1px rgba(107,142,240,.12)}
.event-card:hover::before{opacity:1}
.ec-head{padding:20px 22px 16px;border-bottom:1px solid var(--border)}
.ec-name{font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;line-height:1.3}
.ec-tags{display:flex;flex-wrap:wrap;gap:6px}
.ec-tag{font-size:10px;padding:2px 9px;border-radius:20px;font-family:'DM Mono',monospace;letter-spacing:.04em}
.tag-date{background:rgba(22,32,64,.8);color:var(--text3);border:1px solid var(--border)}
.tag-threshold{background:var(--gold-dim);border:1px solid rgba(232,200,106,.2);color:var(--gold)}
.tag-fx{background:rgba(107,142,240,.1);border:1px solid rgba(107,142,240,.2);color:var(--sky)}
.ec-body{padding:14px 22px}
.ec-desc{font-size:12px;color:var(--text3);line-height:1.6}
.ec-foot{padding:12px 22px;background:rgba(10,15,30,.5);display:flex;align-items:center;justify-content:space-between;border-top:1px solid var(--border)}
.ec-count{font-size:11px;color:var(--text3)}
.btn-enter{padding:6px 16px;background:linear-gradient(135deg,var(--royal),var(--royal-lt));border:none;border-radius:8px;color:#fff;font-size:12px;cursor:pointer;transition:all .15s;font-family:'Noto Sans TC',sans-serif;letter-spacing:.04em}
.btn-enter:hover{box-shadow:0 2px 12px var(--glow);transform:translateY(-1px)}

/* â”€â”€ PRODUCTS VIEW â”€â”€ */
.back-btn{display:inline-flex;align-items:center;gap:6px;background:transparent;border:1px solid var(--border);border-radius:var(--r);color:var(--text2);padding:7px 14px;cursor:pointer;font-size:13px;font-family:'Noto Sans TC',sans-serif;transition:all .15s;margin-bottom:22px}
.back-btn:hover{background:rgba(45,79,212,.1);border-color:var(--border2);color:var(--sky-lt)}
.pv-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:18px}
.pv-title{font-size:20px;font-weight:700;color:var(--text);margin-bottom:8px}
.threshold-bar{display:flex;align-items:center;gap:10px;padding:12px 18px;background:var(--gold-dim);border:1px solid rgba(232,200,106,.2);border-radius:var(--r);margin-bottom:20px;font-size:13px;color:var(--gold)}
.fx-chip{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;background:rgba(45,79,212,.15);border:1px solid var(--border2);border-radius:var(--r);font-size:12px;color:var(--sky-lt);font-family:'DM Mono',monospace}

/* Table */
.ptable-wrap{background:linear-gradient(145deg,rgba(14,22,40,.9),rgba(10,15,30,.95));border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden}
.ptable{width:100%;border-collapse:collapse}
.ptable th{padding:12px 18px;text-align:left;font-size:10px;font-weight:600;letter-spacing:.14em;color:var(--text3);text-transform:uppercase;background:rgba(10,15,30,.7);border-bottom:1px solid var(--border);font-family:'DM Mono',monospace}
.ptable td{padding:14px 18px;font-size:13px;border-bottom:1px solid rgba(45,79,212,.1);transition:background .1s}
.ptable tr:last-child td{border-bottom:none}
.ptable tr:hover td{background:rgba(45,79,212,.06)}
.price-orig{font-family:'DM Mono',monospace;color:var(--sky);font-size:13px}
.price-twd{font-family:'DM Mono',monospace;color:var(--gold);font-size:11px;margin-top:3px;opacity:.85}
.qty-ctrl{display:flex;align-items:center;gap:8px}
.qty-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:rgba(22,32,64,.8);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;font-size:14px;transition:all .1s}
.qty-btn:hover{background:rgba(45,79,212,.3);border-color:var(--border2);color:var(--sky-lt)}
.qty-num{font-family:'DM Mono',monospace;font-size:13px;min-width:22px;text-align:center;color:var(--text)}

/* Member pills */
.member-grid{display:flex;flex-wrap:wrap;gap:5px;padding:4px 0}
.mcb{display:none}
.mpill{display:inline-flex;align-items:center;justify-content:center;width:32px;height:28px;background:rgba(22,32,64,.7);border:1px solid var(--border);border-radius:6px;font-size:13px;color:var(--text3);cursor:pointer;transition:all .12s;user-select:none;font-weight:500}
.mpill:hover{background:rgba(45,79,212,.2);border-color:var(--border2);color:var(--text2)}
.mcb:checked+.mpill{background:rgba(45,79,212,.3);border-color:var(--royal-lt);color:var(--sky-lt);box-shadow:0 0 8px rgba(45,79,212,.3)}

/* â”€â”€ CART â”€â”€ */
.cart-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;backdrop-filter:blur(5px)}
.cart-ov.open{display:block}
.cart-panel{position:fixed;top:0;right:0;width:390px;height:100%;background:linear-gradient(180deg,rgba(14,22,40,.99),rgba(10,15,30,.99));border-left:1px solid var(--border);z-index:201;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .32s cubic-bezier(.25,.46,.45,.94);box-shadow:-20px 0 60px rgba(0,0,0,.5)}
.cart-ov.open .cart-panel{transform:translateX(0)}
.cart-head{padding:22px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.cart-head h3{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px;color:var(--sky-lt)}
.close-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:8px;color:var(--text3);cursor:pointer;font-size:16px;transition:all .15s}
.close-btn:hover{background:var(--red-dim);border-color:var(--red);color:var(--red)}
.cart-items-list{flex:1;overflow-y:auto;padding:16px}
.cart-items-list::-webkit-scrollbar{width:4px}
.cart-items-list::-webkit-scrollbar-track{background:transparent}
.cart-items-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.cart-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;background:rgba(22,32,64,.4);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;animation:fadeIn .2s ease}
.ci-info{flex:1;min-width:0}
.ci-name{font-size:13px;font-weight:500;margin-bottom:3px;line-height:1.4}
.ci-ev{font-size:11px;color:var(--text3);margin-bottom:5px}
.ci-members{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px}
.ci-mem-tag{font-size:10px;padding:1px 6px;background:rgba(45,79,212,.2);border:1px solid rgba(107,142,240,.2);border-radius:4px;color:var(--sky);font-family:'DM Mono',monospace}
.ci-price{font-family:'DM Mono',monospace;font-size:11px;color:var(--sky-lt)}
.ci-twd{font-family:'DM Mono',monospace;font-size:10px;color:var(--gold);opacity:.8;margin-top:2px}
.ci-rm{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;color:var(--text3);cursor:pointer;border-radius:4px;font-size:14px;transition:all .1s;flex-shrink:0;margin-top:1px}
.ci-rm:hover{color:var(--red);background:var(--red-dim)}
.cart-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--text3);gap:12px}
.cart-empty .ico{font-size:40px;opacity:.3}
.cart-empty p{font-size:13px}
.cart-foot{padding:20px 24px;border-top:1px solid var(--border);background:rgba(10,15,30,.6)}
.sum-row{display:flex;justify-content:space-between;font-size:13px;color:var(--text2);padding:4px 0}
.sum-row.total{font-size:16px;font-weight:700;color:var(--text);padding-top:10px;margin-top:6px;border-top:1px solid var(--border)}
.sv{font-family:'DM Mono',monospace}
.card-badges{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0 14px}
.card-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--gold-dim);border:1px solid rgba(232,200,106,.25);border-radius:20px;font-size:11px;color:var(--gold);font-family:'DM Mono',monospace}
.remark-inp{width:100%;padding:9px 12px;background:rgba(22,32,64,.5);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:13px;resize:none;margin-bottom:12px;min-height:60px;transition:border-color .15s}
.remark-inp:focus{outline:none;border-color:var(--border2)}
.remark-inp::placeholder{color:var(--text4)}
.btn-primary{width:100%;padding:13px;background:linear-gradient(135deg,var(--royal),var(--royal-lt));color:#fff;border:none;border-radius:var(--r);font-family:'Noto Sans TC',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.08em;box-shadow:0 4px 20px var(--glow)}
.btn-primary:hover:not(:disabled){box-shadow:0 4px 28px rgba(45,79,212,.55);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.4;cursor:default;transform:none}

/* â”€â”€ ADMIN â”€â”€ */
.admin-card{background:linear-gradient(145deg,rgba(14,22,40,.85),rgba(10,15,30,.9));border:1px solid var(--border);border-radius:var(--r-lg);padding:26px;margin-bottom:22px}
.card-title{font-size:13px;font-weight:700;letter-spacing:.1em;color:var(--sky-lt);margin-bottom:22px;display:flex;align-items:center;gap:10px;text-transform:uppercase}
.card-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
.fgrid.g3{grid-template-columns:2fr 1fr 1fr}
.fg{display:flex;flex-direction:column;gap:6px}
.fg.full{grid-column:1/-1}
.fl{font-size:10px;font-weight:600;letter-spacing:.14em;color:var(--text3);text-transform:uppercase;font-family:'DM Mono',monospace}
.fi,.fsel{padding:9px 12px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:13px;transition:border-color .15s;width:100%}
.fi:focus,.fsel:focus{outline:none;border-color:var(--border2);background:rgba(22,32,64,.9)}
.fi::placeholder{color:var(--text4)}
.fsel{cursor:pointer}
option{background:var(--navy-mid)}
.prow-head{display:grid;grid-template-columns:1.8fr 90px 100px 130px 100px 36px;gap:8px;margin-bottom:6px;padding:0 2px}
.prow-head span{font-size:10px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-family:'DM Mono',monospace}
.prow{display:grid;grid-template-columns:1.8fr 90px 100px 130px 100px 36px;gap:8px;margin-bottom:8px;align-items:center}
.prow input{padding:8px 10px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:13px;transition:border-color .15s;width:100%}
.prow input:focus{outline:none;border-color:var(--border2)}
.prow input::placeholder{color:var(--text4)}
.rm-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:6px;color:var(--red);cursor:pointer;font-size:15px;transition:all .1s}
.rm-btn:hover{background:rgba(248,113,113,.18)}
.add-row-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;background:transparent;border:1px dashed var(--border2);border-radius:var(--r);color:var(--text3);cursor:pointer;font-size:13px;font-family:'Noto Sans TC',sans-serif;transition:all .15s;margin-top:4px}
.add-row-btn:hover{border-color:var(--royal-lt);color:var(--sky-lt);background:rgba(45,79,212,.1)}
.save-btn{padding:10px 28px;background:linear-gradient(135deg,var(--royal),var(--royal-lt));border:none;border-radius:var(--r);color:#fff;font-family:'Noto Sans TC',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.06em;box-shadow:0 4px 16px var(--glow-sm)}
.save-btn:hover{box-shadow:0 4px 24px var(--glow);transform:translateY(-1px)}
.fx-badge{font-size:10px;padding:2px 8px;background:rgba(107,142,240,.12);border:1px solid rgba(107,142,240,.2);border-radius:20px;color:var(--sky);font-family:'DM Mono',monospace}

/* â”€â”€ ORDERS TABLE â”€â”€ */
.otable-wrap{background:linear-gradient(145deg,rgba(14,22,40,.9),rgba(10,15,30,.95));border:1px solid var(--border);border-radius:var(--r-lg);overflow:hidden}
.otable{width:100%;border-collapse:collapse;font-size:13px}
.otable th{padding:12px 16px;text-align:left;font-size:10px;font-weight:600;letter-spacing:.14em;color:var(--text3);text-transform:uppercase;background:rgba(10,15,30,.6);border-bottom:1px solid var(--border);font-family:'DM Mono',monospace}
.otable td{padding:12px 16px;border-bottom:1px solid rgba(45,79,212,.08);vertical-align:top;color:var(--text2)}
.otable tr:last-child td{border-bottom:none}
.otable tr:hover td{background:rgba(45,79,212,.05)}
.ot-user{font-family:'DM Mono',monospace;color:var(--sky-lt);font-size:12px}
.ot-total{font-family:'DM Mono',monospace;color:var(--gold)}
.ot-date{font-size:11px;color:var(--text3)}
.ot-mem-tag{font-size:10px;padding:1px 6px;background:rgba(45,79,212,.15);border:1px solid rgba(107,142,240,.2);border-radius:4px;color:var(--sky);font-family:'DM Mono',monospace;display:inline-block;margin:2px 1px}
.ot-card{font-size:10px;padding:2px 8px;background:var(--gold-dim);border:1px solid rgba(232,200,106,.2);border-radius:20px;color:var(--gold);font-family:'DM Mono',monospace;display:inline-block;margin:2px}
.ot-items{line-height:1.9}

/* â”€â”€ MISC â”€â”€ */
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .ico{font-size:48px;opacity:.25;display:block;margin-bottom:16px}
.empty-state p{font-size:14px}
.loading{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--royal-lt);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}

/* â”€â”€ MODAL â”€â”€ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-ov.open{display:flex}
.modal-box{background:linear-gradient(145deg,rgba(22,32,64,.98),rgba(14,22,40,.99));border:1px solid var(--border2);border-radius:var(--r-lg);padding:28px;width:400px;max-width:90vw;animation:fadeUp .2s ease;box-shadow:0 20px 60px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.03)}
.modal-box h3{font-size:16px;font-weight:700;margin-bottom:10px;color:var(--sky-lt)}
.modal-box p{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:22px}
.modal-btns{display:flex;gap:10px;justify-content:flex-end}
.btn-ghost{padding:8px 18px;background:transparent;border:1px solid var(--border);border-radius:var(--r);color:var(--text2);cursor:pointer;font-size:13px;font-family:'Noto Sans TC',sans-serif;transition:all .15s}
.btn-ghost:hover{background:rgba(22,32,64,.8)}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:rgba(22,32,64,.95);border:1px solid var(--border2);border-radius:var(--r);padding:12px 22px;font-size:13px;color:var(--text);z-index:999;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 16px var(--glow-sm);white-space:nowrap;backdrop-filter:blur(8px)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{border-color:rgba(74,222,128,.35);color:var(--green)}
.toast.error{border-color:rgba(248,113,113,.35);color:var(--red)}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes loginReveal{from{opacity:0;transform:translateY(24px) scale(.97)}to{opacity:1;transform:none}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulseDot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:640px){
  .cart-panel{width:100%}
  .fgrid,.fgrid.g3{grid-template-columns:1fr}
  .events-grid{grid-template-columns:1fr}
  .main{padding:16px}
  .tabs{padding:12px 16px 0;overflow-x:auto}
  .prow,.prow-head{grid-template-columns:1fr 80px 80px 100px 80px 36px}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â• -->
<div id="login-screen" class="screen active">
  <div class="login-wrap">
    <div class="login-crest">
      <div class="crest-ring">ğŸ‘‘</div>
      <span class="login-title">SJ PROXY</span>
      <span class="login-sub">Super Junior ä»£è³¼ç³»çµ±</span>
    </div>
    <span class="login-sect">é¸æ“‡å¸³è™Ÿ</span>
    <div class="user-grid" style="grid-template-columns:1fr 1fr 1fr">
      <button class="user-btn" data-user="Armani" onclick="selectUser(this)">Armani</button>
      <button class="user-btn" data-user="9n" onclick="selectUser(this)">9n</button>
      <button class="user-btn" data-user="Cindyæ¬£æ€¡" onclick="selectUser(this)">Cindyæ¬£æ€¡</button>
      <button class="user-btn" data-user="Lilian Lin" onclick="selectUser(this)">Lilian Lin</button>
      <button class="user-btn" data-user="Lydia" onclick="selectUser(this)">Lydia</button>
      <button class="user-btn" data-user="mwah" onclick="selectUser(this)">mwah</button>
      <button class="user-btn" data-user="MÉªAÂ·ÍœÂ·â™¡" onclick="selectUser(this)">MÉªAÂ·ÍœÂ·â™¡</button>
      <button class="user-btn" data-user="shin" onclick="selectUser(this)">shin</button>
      <button class="user-btn" data-user="å¼µæƒ å©·Hui-Ting" onclick="selectUser(this)">å¼µæƒ å©·Hui-Ting</button>
      <button class="user-btn" data-user="å¼µèŠ·ç¶­ç¶­ç¶­" onclick="selectUser(this)">å¼µèŠ·ç¶­ç¶­ç¶­</button>
      <button class="user-btn" data-user="ğ˜½ğ™–ğ™£ğ™™ğ™–ğ™£â‹†â˜½" onclick="selectUser(this)">ğ˜½ğ™–ğ™£ğ™™ğ™–ğ™£â‹†â˜½</button>
      <button class="user-btn admin-btn" data-user="ç®¡ç†å“¡" onclick="selectUser(this)" style="grid-column:1/-1">âœ¦ ç®¡ç†å“¡</button>
    </div>
    <button class="btn-login" id="login-btn" disabled onclick="doLogin()">é€²å…¥ç³»çµ±</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• APP â•â•â•â•â•â•â• -->
<div id="app-screen" class="screen">
  <div class="topbar">
    <div class="topbar-l">
      <div class="wordmark"><span>âœ¦</span> SJ PROXY</div>
      <div class="tdiv"></div>
      <div class="user-chip">
        <span class="chip-dot" id="chip-dot"></span>
        <span id="user-label"></span>
      </div>
    </div>
    <div class="topbar-r">
      <button class="cart-btn" id="cart-btn" onclick="toggleCart()" style="display:none">
        ğŸ›’ è³¼ç‰©è»Š
        <span class="cart-badge hidden" id="cart-badge">0</span>
      </button>
      <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="events" onclick="switchTab('events')">æ´»å‹•å ´æ¬¡</button>
    <button class="tab" data-tab="admin" id="tab-admin-btn" style="display:none" onclick="switchTab('admin')">âš™ ç®¡ç†å¾Œå°</button>
    <button class="tab" data-tab="orders" id="tab-orders-btn" style="display:none" onclick="switchTab('orders')">ğŸ“‹ è¨‚å–®è¨˜éŒ„</button>
  </div>

  <div class="main">

    <!-- Events pane -->
    <div id="pane-events">
      <div id="view-list">
        <div class="events-grid" id="events-grid">
          <div class="empty-state"><span class="ico">ğŸ“­</span><p>ç›®å‰æ²’æœ‰æ´»å‹•å ´æ¬¡</p></div>
        </div>
      </div>

      <div id="view-products" style="display:none">
        <button class="back-btn" onclick="backToList()">â† è¿”å›æ´»å‹•åˆ—è¡¨</button>
        <div class="pv-header">
          <div>
            <div class="pv-title" id="pv-title"></div>
            <div id="pv-tags" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"></div>
          </div>
          <div id="pv-fx" class="fx-chip" style="display:none"></div>
        </div>
        <div id="pv-thresh" class="threshold-bar" style="display:none">
          ğŸ æœ¬æ´»å‹•æ¶ˆè²»æ»¿ <b id="pv-thresh-val" style="font-family:'DM Mono';margin:0 4px"></b> TWD å¯ç²å¾—æ»¿é¡å¡
        </div>
        <div class="ptable-wrap">
          <table class="ptable">
            <thead>
              <tr>
                <th>å“å</th>
                <th>å‚™æ³¨</th>
                <th>å”®åƒ¹</th>
                <th style="width:130px">æ•¸é‡</th>
                <th>é¸é …</th>
              </tr>
            </thead>
            <tbody id="prod-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Admin pane -->
    <div id="pane-admin" style="display:none">
      <div class="admin-card">
        <div class="card-title">âœ¦ æ–°å¢æ´»å‹•å ´æ¬¡</div>
        <div class="fgrid">
          <div class="fg">
            <label class="fl">æ´»å‹•åç¨±</label>
            <input class="fi" id="a-name" placeholder="ä¾‹ï¼šSUPER JUNIOR WORLD TOUR å‘¨é‚Š">
          </div>
          <div class="fg">
            <label class="fl">æ´»å‹•æ—¥æœŸ</label>
            <input class="fi" type="date" id="a-date">
          </div>
        </div>
        <div class="fgrid g3">
          <div class="fg">
            <label class="fl">å•†å“å¹£åˆ¥</label>
            <select class="fsel" id="a-currency" onchange="updateRateHelp()">
              <option value="TWD">TWD â€” æ–°å°å¹£</option>
              <option value="KRW">KRW â€” éŸ“å…ƒ</option>
              <option value="JPY">JPY â€” æ—¥å…ƒ</option>
              <option value="USD">USD â€” ç¾å…ƒ</option>
              <option value="CNY">CNY â€” äººæ°‘å¹£</option>
              <option value="HKD">HKD â€” æ¸¯å¹£</option>
              <option value="EUR">EUR â€” æ­å…ƒ</option>
            </select>
          </div>
          <div class="fg" id="rate-grp">
            <label class="fl">åŒ¯ç‡ 1 <span id="rate-cur-label" style="color:var(--sky)"></span> = ? TWD</label>
            <input class="fi" type="number" id="a-rate" placeholder="ä¾‹ï¼š0.023" step="0.0001" min="0.0001" value="1">
          </div>
          <div class="fg">
            <label class="fl">æ»¿é¡å¡é–€æª» <span id="threshold-cur-label">TWD</span>ï¼ˆ0=ä¸è¨­ï¼‰</label>
            <input class="fi" type="number" id="a-threshold" placeholder="0" min="0">
          </div>
        </div>
        <div class="fgrid">
          <div class="fg">
            <label class="fl">æ´»å‹•èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <input class="fi" id="a-desc" placeholder="è£œå……è³‡è¨Š">
          </div>
          <div class="fg" style="visibility:hidden">
            <label class="fl">ä½”ä½</label>
            <input class="fi" disabled>
          </div>
        </div>

        <div class="fl" style="margin-bottom:10px">å•†å“åˆ—è¡¨</div>
        <div class="prow-head">
          <span>å“åï¼ˆä¸­è‹±æ–‡å‡å¯ï¼‰</span>
          <span>å”®åƒ¹ï¼ˆåŸå¹£ï¼‰</span>
          <span>å‚™æ³¨</span>
          <span>é¸é …é¡å‹</span>
          <span>è‡ªè¨‚é¸é …å€¼</span>
          <span></span>
        </div>
        <div id="prod-list"></div>
        <button class="add-row-btn" onclick="addProdRow()">ï¼‹ æ–°å¢å•†å“</button>
        <br><br>
        <button class="save-btn" onclick="saveEvent()">å„²å­˜æ´»å‹•</button>
      </div>

      <div class="admin-card">
        <div class="card-title">ğŸ“‹ ç®¡ç†æ´»å‹•</div>
        <div id="admin-ev-list">
          <div class="empty-state" style="padding:30px 0"><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>
        </div>
      </div>
    </div>

    <!-- Orders pane -->
    <div id="pane-orders" style="display:none">
      <div id="orders-wrap">
        <div class="empty-state"><span class="ico">ğŸ“‹</span><p>ç›®å‰æ²’æœ‰è¨‚å–®è¨˜éŒ„</p></div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â• CART â•â•â•â•â•â•â• -->
<div class="cart-ov" id="cart-ov" onclick="ovClick(event)">
  <div class="cart-panel">
    <div class="cart-head">
      <h3>ğŸ›’ è³¼ç‰©è»Š</h3>
      <button class="close-btn" onclick="toggleCart()">âœ•</button>
    </div>
    <div class="cart-items-list" id="cart-items-list"></div>
    <div class="cart-foot">
      <div id="cart-sum"></div>
      <textarea class="remark-inp" id="cart-remark" placeholder="å‚™æ³¨ï¼ˆé¸å¡«ï¼‰"></textarea>
      <button class="btn-primary" id="submit-btn" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â• -->
<div class="modal-ov" id="modal">
  <div class="modal-box">
    <h3 id="modal-title"></h3>
    <p id="modal-msg"></p>
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-primary" style="width:auto;padding:9px 22px" id="modal-ok">ç¢ºèª</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ CONFIG â”€â”€
const API_URL = 'https://script.google.com/macros/s/AKfycbxvVvx7nFBOS-VvU4fSrebpYQCCCLcKCgkIB05EDZMjx_jfXkpGdke-7n1TQ4UPvLcu/exec';
const MEMBERS = ['ç‰¹','æ¾ˆ','é›²','ç«¥','èµ«','æµ·','æº','æ—­','åœ­'];
const FX_DEFAULTS = {KRW:'0.023',JPY:'0.21',USD:'32',CNY:'4.4',HKD:'4.1',EUR:'35'};

// â”€â”€ STATE â”€â”€
let currentUser = null;
let events = [];
let cart = [];
let _loginUser = null;

// â”€â”€ LOCAL STORAGE â”€â”€
const LS = 'sj_proxy_v3';
function saveLocal(){ localStorage.setItem(LS, JSON.stringify(events)); }
function loadLocal(){ try{ events = JSON.parse(localStorage.getItem(LS))||[]; }catch(e){ events=[]; } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectUser(btn){
  document.querySelectorAll('.user-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  _loginUser = btn.dataset.user;
  document.getElementById('login-btn').disabled = false;
}

function doLogin(){
  currentUser = _loginUser;
  const isAdmin = currentUser === 'ç®¡ç†å“¡';
  document.getElementById('user-label').textContent = isAdmin ? 'ç®¡ç†å“¡' : `ç”¨æˆ¶ ${currentUser}`;
  document.getElementById('chip-dot').className = 'chip-dot' + (isAdmin ? ' gold' : '');
  document.getElementById('login-screen').classList.remove('active');
  document.getElementById('app-screen').classList.add('active');
  if(isAdmin){
    document.getElementById('tab-admin-btn').style.display = '';
    document.getElementById('tab-orders-btn').style.display = '';
    document.getElementById('cart-btn').style.display = 'none';
    addProdRow();
    updateRateHelp();
  } else {
    document.getElementById('cart-btn').style.display = '';
  }
  loadLocal();
  renderEvents();
}

function logout(){
  currentUser = null; _loginUser = null; cart = [];
  document.querySelectorAll('.user-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('login-btn').disabled = true;
  document.getElementById('app-screen').classList.remove('active');
  document.getElementById('login-screen').classList.add('active');
  switchTab('events');
  document.getElementById('view-list').style.display = '';
  document.getElementById('view-products').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));
  ['events','admin','orders'].forEach(p=>{
    document.getElementById('pane-'+p).style.display = p===t?'':'none';
  });
  if(t==='admin') renderAdminEvents();
  if(t==='orders') loadOrders();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEvents(){
  const grid = document.getElementById('events-grid');
  if(!events.length){
    grid.innerHTML = '<div class="empty-state"><span class="ico">ğŸ“­</span><p>ç›®å‰æ²’æœ‰æ´»å‹•å ´æ¬¡</p></div>';
    return;
  }
  grid.innerHTML = events.map(e=>`
    <div class="event-card" onclick="openEvent('${e.id}')">
      <div class="ec-head">
        <div class="ec-name">${esc(e.name)}</div>
        <div class="ec-tags">
          ${e.date?`<span class="ec-tag tag-date">ğŸ“… ${e.date}</span>`:''}
          ${e.threshold>0?`<span class="ec-tag tag-threshold">ğŸ æ»¿ ${fmt(e.threshold)} TWD</span>`:''}
          ${e.currency&&e.currency!=='TWD'?`<span class="ec-tag tag-fx">ğŸ’± ${e.currency} Ã— ${e.rate}</span>`:''}
          ${e.products&&e.products.some(p=>p.optType==='members')?`<span class="ec-tag tag-fx">ğŸ‘¥ å¯é¸æˆå“¡</span>`:''}
        </div>
      </div>
      ${e.desc?`<div class="ec-body"><p class="ec-desc">${esc(e.desc)}</p></div>`:''}
      <div class="ec-foot">
        <span class="ec-count">å…± ${e.products.length} é …å•†å“</span>
        <button class="btn-enter" onclick="event.stopPropagation();openEvent('${e.id}')">é¸è³¼ â†’</button>
      </div>
    </div>
  `).join('');
}

function openEvent(id){
  const ev = events.find(e=>e.id===id);
  if(!ev) return;
  document.getElementById('view-list').style.display = 'none';
  document.getElementById('view-products').style.display = '';

  document.getElementById('pv-title').textContent = ev.name;

  // tags
  let tags = '';
  if(ev.date) tags += `<span class="ec-tag tag-date">ğŸ“… ${ev.date}</span>`;
  if(ev.threshold>0) tags += `<span class="ec-tag tag-threshold">ğŸ æ»¿ ${fmt(ev.threshold)} TWD ç²å¾—æ»¿é¡å¡</span>`;
  document.getElementById('pv-tags').innerHTML = tags;

  // fx chip
  const fxEl = document.getElementById('pv-fx');
  if(ev.currency && ev.currency!=='TWD'){
    fxEl.style.display = '';
    fxEl.innerHTML = `ğŸ’± 1 ${ev.currency} = ${ev.rate} TWD`;
  } else { fxEl.style.display = 'none'; }

  // threshold
  const thEl = document.getElementById('pv-thresh');
  if(ev.threshold>0){
    thEl.style.display = 'flex';
    document.getElementById('pv-thresh-val').textContent = fmt(ev.threshold);
  } else { thEl.style.display = 'none'; }

  // products
  const tbody = document.getElementById('prod-tbody');
  const isTWD = !ev.currency || ev.currency==='TWD';

  if(!ev.products.length){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:30px">æ­¤æ´»å‹•å°šç„¡å•†å“</td></tr>`;
    return;
  }

  tbody.innerHTML = ev.products.map((p,i)=>{
    const twdP = isTWD ? p.price : Math.round(p.price * ev.rate);
    const priceHtml = isTWD
      ? `<div class="price-orig">NT$ ${fmt(p.price)}</div>`
      : `<div class="price-orig">${ev.currency} ${fmt(p.price)}</div><div class="price-twd">â‰ˆ NT$ ${fmt(twdP)}</div>`;

    const memberTd = (()=>{
      if(currentUser==='ç®¡ç†å“¡'){
        return p.optType&&p.optType!=='none' ? `<td><span style="color:var(--text3);font-size:11px">ï¼ˆç®¡ç†å“¡ï¼‰</span></td>` : `<td style="color:var(--text3)">â€”</td>`;
      }
      if(p.optType==='members'){
        return `<td><div class="member-grid" id="mg-${id}-${i}">
          ${MEMBERS.map(m=>`
            <input type="checkbox" class="mcb" id="mc-${id}-${i}-${encodeURIComponent(m)}">
            <label class="mpill" for="mc-${id}-${i}-${encodeURIComponent(m)}">${m}</label>
          `).join('')}
        </div></td>`;
      }
      if(p.optType==='custom' && p.optVals && p.optVals.length){
        return `<td><div class="member-grid" id="mg-${id}-${i}">
          ${p.optVals.map(v=>`
            <input type="checkbox" class="mcb" id="mc-${id}-${i}-${encodeURIComponent(v)}">
            <label class="mpill" for="mc-${id}-${i}-${encodeURIComponent(v)}" style="width:auto;padding:0 10px;font-size:12px">${esc(v)}</label>
          `).join('')}
        </div></td>`;
      }
      return `<td style="color:var(--text3)">â€”</td>`;
    })();

    return `<tr>
      <td style="font-weight:500;color:var(--text)">${esc(p.name)}</td>
      <td style="color:var(--text3);font-size:12px">${esc(p.note||'')}</td>
      <td>${priceHtml}</td>
      <td>${currentUser!=='ç®¡ç†å“¡'?`
        <div class="qty-ctrl">
          <button class="qty-btn" onclick="chQty('${id}',${i},-1)">âˆ’</button>
          <span class="qty-num" id="qn-${id}-${i}">0</span>
          <button class="qty-btn" onclick="chQty('${id}',${i},1)">ï¼‹</button>
        </div>`:`<span style="color:var(--text3);font-size:11px">ï¼ˆç®¡ç†å“¡ï¼‰</span>`}
      </td>
      ${memberTd}
    </tr>`;
  }).join('');

  // restore from cart
  ev.products.forEach((_,i)=>{
    const item = cart.find(c=>c.eid===id&&c.pi===i);
    if(item){
      const el = document.getElementById(`qn-${id}-${i}`);
      if(el) el.textContent = item.qty;
      (item.members||[]).forEach(m=>{
        const cb = document.getElementById(`mc-${id}-${i}-${encodeURIComponent(m)}`);
        if(cb) cb.checked = true;
      });
    }
  });
}

function backToList(){
  document.getElementById('view-list').style.display = '';
  document.getElementById('view-products').style.display = 'none';
}

// â”€â”€â”€ Qty â”€â”€â”€
function chQty(eid, pi, delta){
  const ev = events.find(e=>e.id===eid);
  if(!ev) return;
  const p = ev.products[pi];
  const isTWD = !ev.currency || ev.currency==='TWD';
  const twdP = isTWD ? p.price : Math.round(p.price * ev.rate);

  let item = cart.find(c=>c.eid===eid&&c.pi===pi);
  const newQty = Math.max(0, (item?item.qty:0) + delta);

  if(newQty===0){
    cart = cart.filter(c=>!(c.eid===eid&&c.pi===pi));
  } else if(item){
    item.qty = newQty;
  } else {
    cart.push({
      eid, ename:ev.name, pi, pname:p.name,
      priceOrig:p.price, priceTWD:twdP,
      currency:ev.currency||'TWD', rate:ev.rate||1,
      qty:newQty, members:[], threshold:ev.threshold,
      thresholdCurrency:ev.currency||'TWD', thresholdRate:ev.rate||1
    });
  }
  const el = document.getElementById(`qn-${eid}-${pi}`);
  if(el) el.textContent = newQty;
  updateBadge();
}

function getCheckedMembers(eid, pi){
  const ev = events.find(e=>e.id===eid);
  const p = ev ? ev.products[pi] : null;
  if(!p || !p.optType || p.optType==='none') return [];
  const vals = p.optType==='members' ? MEMBERS : (p.optVals||[]);
  return vals.filter(v=>{
    const cb = document.getElementById(`mc-${eid}-${pi}-${encodeURIComponent(v)}`);
    return cb && cb.checked;
  });
}

function updateBadge(){
  const n = cart.reduce((s,i)=>s+i.qty,0);
  const b = document.getElementById('cart-badge');
  b.textContent = n;
  b.classList.toggle('hidden', n===0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCart(){
  document.getElementById('cart-ov').classList.toggle('open');
  renderCart();
}
function ovClick(e){ if(e.target===document.getElementById('cart-ov')) toggleCart(); }

function renderCart(){
  const list = document.getElementById('cart-items-list');
  const sumEl = document.getElementById('cart-sum');

  if(!cart.length){
    list.innerHTML = '<div class="cart-empty"><span class="ico">ğŸ›’</span><p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p></div>';
    sumEl.innerHTML = '';
    return;
  }

  list.innerHTML = cart.map((item,idx)=>`
    <div class="cart-item">
      <div class="ci-info">
        <div class="ci-name">${esc(item.pname)}</div>
        <div class="ci-ev">${esc(item.ename)}</div>
        ${item.members&&item.members.length?`<div class="ci-members">${item.members.map(m=>`<span class="ci-mem-tag">${m}</span>`).join('')}</div>`:''}
        <div class="ci-price">
          ${item.currency!=='TWD'?`${item.currency} ${fmt(item.priceOrig)} Ã— ${item.qty} &nbsp;|&nbsp; `:''}NT$ ${fmt(item.priceTWD * item.qty)}
        </div>
        ${item.currency!=='TWD'?`<div class="ci-twd">åŸå¹£ ${item.currency} ${fmt(item.priceOrig*item.qty)}</div>`:''}
      </div>
      <button class="ci-rm" onclick="rmCart(${idx})">âœ•</button>
    </div>
  `).join('');

  const subtotal = cart.reduce((s,i)=>s+i.priceTWD*i.qty,0);

  // cardsï¼ˆç”¨åŸå¹£è¨ˆç®—ï¼‰
  const evTotals={};
  cart.forEach(i=>{
    if(!evTotals[i.eid]) evTotals[i.eid]={name:i.ename,total:0,thr:i.threshold,cur:i.thresholdCurrency||'TWD'};
    evTotals[i.eid].total += i.priceOrig*i.qty;
  });
  const cards=[];
  Object.values(evTotals).forEach(ev=>{
    if(ev.thr>0&&ev.total>=ev.thr){
      const n=Math.floor(ev.total/ev.thr);
      for(let i=0;i<n;i++) cards.push(ev.name+' æ»¿é¡å¡');
    }
  });

  let html = `<div class="sum-row"><span>å°è¨ˆ</span><span class="sv">NT$ ${fmt(subtotal)}</span></div>`;
  if(cards.length){
    html += '<div class="card-badges">';
    cards.forEach(c=>{ html+=`<span class="card-badge">ğŸ ${esc(c)}</span>`; });
    html += '</div>';
  }
  html += `<div class="sum-row total"><span>åˆè¨ˆ</span><span class="sv">NT$ ${fmt(subtotal)}</span></div>`;
  sumEl.innerHTML = html;
}

function rmCart(idx){
  const item = cart[idx];
  cart.splice(idx,1);
  const el = document.getElementById(`qn-${item.eid}-${item.pi}`);
  if(el) el.textContent = '0';
  updateBadge(); renderCart();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitOrder(){
  if(!cart.length){ toast('è³¼ç‰©è»Šæ˜¯ç©ºçš„','error'); return; }

  // Sync options from checkboxes
  cart.forEach(item=>{
    item.members = getCheckedMembers(item.eid, item.pi);
  });

  const subtotal = cart.reduce((s,i)=>s+i.priceTWD*i.qty,0);
  const remark = document.getElementById('cart-remark').value.trim();
  const evTotals={};
  cart.forEach(i=>{
    if(!evTotals[i.eid]) evTotals[i.eid]={name:i.ename,total:0,thr:i.threshold,cur:i.thresholdCurrency||'TWD'};
    evTotals[i.eid].total += i.priceOrig*i.qty;  // ç”¨åŸå¹£ç´¯åŠ 
  });
  const cards=[];
  Object.values(evTotals).forEach(ev=>{
    if(ev.thr>0&&ev.total>=ev.thr){
      const n=Math.floor(ev.total/ev.thr);
      for(let i=0;i<n;i++) cards.push(ev.name+' æ»¿é¡å¡');
    }
  });

  const payload={
    action:'submitOrder', user:currentUser,
    items:cart.map(i=>({
      eventName:i.ename, prodName:i.pname,
      priceOrig:i.priceOrig, priceTWD:i.priceTWD,
      currency:i.currency, qty:i.qty, members:i.members||[]
    })),
    subtotal, cards, remark,
    timestamp:new Date().toLocaleString('zh-TW')
  };

  const btn = document.getElementById('submit-btn');
  btn.innerHTML = '<span class="loading"></span>é€å‡ºä¸­...';
  btn.disabled = true;

  callAPI(payload)
    .then(()=>{
      toast('è¨‚å–®å·²é€å‡ºï¼','success');
      cart=[];
      document.getElementById('cart-remark').value='';
      updateBadge();
      document.getElementById('cart-ov').classList.remove('open');
      document.querySelectorAll('.qty-num').forEach(el=>el.textContent='0');
      document.querySelectorAll('.mcb').forEach(cb=>cb.checked=false);
    })
    .catch(()=>toast('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦','error'))
    .finally(()=>{ btn.innerHTML='ç¢ºèªé€å‡ºè¨‚å–®'; btn.disabled=false; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN â€” Events
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRateHelp(){
  const cur = document.getElementById('a-currency')?.value;
  const rateEl = document.getElementById('a-rate');
  const grp = document.getElementById('rate-grp');
  const lbl = document.getElementById('rate-cur-label');
  if(!cur) return;
  if(cur==='TWD'){
    rateEl.value='1'; grp.style.opacity='.4';
    if(lbl) lbl.textContent='TWD';
  } else {
    grp.style.opacity='1';
    if(rateEl.value===''||rateEl.value==='1') rateEl.value = FX_DEFAULTS[cur]||'';
    if(lbl) lbl.textContent=cur;
  }
  document.getElementById('threshold-cur-label').textContent = cur;
}

function addProdRow(n='',p='',no='',optType='none',optVals=''){
  const list = document.getElementById('prod-list');
  const row = document.createElement('div');
  row.className = 'prow';
  row.innerHTML = `
    <input placeholder="å“åï¼ˆä¸­è‹±å‡å¯ï¼‰" value="${esc(n)}" class="pn">
    <input placeholder="åŸå¹£å”®åƒ¹" type="number" value="${p}" class="pp" min="0" step="0.01">
    <input placeholder="å‚™æ³¨" value="${esc(no)}" class="pno">
    <select class="pot" onchange="this.nextElementSibling.style.display=this.value==='custom'?'block':'none'" style="padding:8px 8px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:12px;cursor:pointer;width:100%">
      <option value="none" ${optType==='none'?'selected':''}>ç„¡é¸é …</option>
      <option value="members" ${optType==='members'?'selected':''}>æˆå“¡é¸æ“‡</option>
      <option value="custom" ${optType==='custom'?'selected':''}>è‡ªè¨‚é¸é …</option>
    </select>
    <input placeholder="ç”¨ / åˆ†éš”ï¼Œä¾‹ï¼šS/M/L" value="${esc(optVals)}" class="povs" style="display:${optType==='custom'?'block':'none'};padding:8px 8px;background:rgba(22,32,64,.6);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Noto Sans TC',sans-serif;font-size:12px;width:100%">
    <button class="rm-btn" onclick="this.parentElement.remove()">âœ•</button>
  `;
  list.appendChild(row);
}

function saveEvent(){
  const name = document.getElementById('a-name').value.trim();
  const date = document.getElementById('a-date').value;
  const currency = document.getElementById('a-currency').value;
  const rate = parseFloat(document.getElementById('a-rate').value)||1;
  const threshold = parseInt(document.getElementById('a-threshold').value)||0;
  const desc = document.getElementById('a-desc').value.trim();

  if(!name){ toast('è«‹è¼¸å…¥æ´»å‹•åç¨±','error'); return; }

  const rows = document.querySelectorAll('#prod-list .prow');
  const products=[]; let valid=true;
  rows.forEach(row=>{
    const pn=row.querySelector('.pn').value.trim();
    const pp=parseFloat(row.querySelector('.pp').value);
    const pno=row.querySelector('.pno').value.trim();
    const pot=row.querySelector('.pot').value;
    const povs=row.querySelector('.povs').value.trim();
    if(pn&&!isNaN(pp)&&pp>=0) products.push({
      name:pn, price:pp, note:pno,
      optType:pot,
      optVals: pot==='custom' ? povs.split('/').map(s=>s.trim()).filter(Boolean) : []
    });
    else if(pn||row.querySelector('.pp').value) valid=false;
  });
  if(!valid){ toast('è«‹ç¢ºèªå•†å“è³‡æ–™å®Œæ•´','error'); return; }
  if(!products.length){ toast('è«‹è‡³å°‘æ–°å¢ä¸€é …å•†å“','error'); return; }

  const ev = {id:'ev_'+Date.now(), name, date, currency, rate, threshold, desc, products};

  events.push(ev);
  saveLocal(); renderEvents(); renderAdminEvents();

  document.getElementById('a-name').value='';
  document.getElementById('a-date').value='';
  document.getElementById('a-threshold').value='';
  document.getElementById('a-desc').value='';
  document.getElementById('prod-list').innerHTML='';
  document.getElementById('a-currency').value='TWD';
  document.getElementById('a-rate').value='1';
  updateRateHelp();
  addProdRow();

  callAPI({action:'saveEvent',event:ev}).catch(()=>{});
  toast('æ´»å‹•å·²å„²å­˜ï¼','success');
}

function renderAdminEvents(){
  const c = document.getElementById('admin-ev-list');
  if(!events.length){
    c.innerHTML = '<div class="empty-state" style="padding:30px 0"><p>ç›®å‰æ²’æœ‰æ´»å‹•</p></div>';
    return;
  }
  c.innerHTML = `
    <div class="otable-wrap">
    <table class="otable">
      <thead><tr>
        <th>æ´»å‹•åç¨±</th><th>æ—¥æœŸ</th><th>å¹£åˆ¥ / åŒ¯ç‡</th><th>æ»¿é¡é–€æª»</th><th>å•†å“</th><th>æ“ä½œ</th>
      </tr></thead>
      <tbody>${events.map(e=>`
        <tr>
          <td style="font-weight:600;color:var(--text)">${esc(e.name)}${e.products&&e.products.some(p=>p.optType==='members')?' <span style="font-size:10px;color:var(--sky)">ğŸ‘¥</span>':''}</td>
          <td>${e.date||'â€”'}</td>
          <td>${e.currency&&e.currency!=='TWD'?`<span class="fx-badge">${e.currency} Ã— ${e.rate}</span>`:'<span style="color:var(--text3)">TWD</span>'}</td>
          <td>${e.threshold>0?`NT$ ${fmt(e.threshold)}`:'â€”'}</td>
          <td>${e.products.length}</td>
          <td><button onclick="deleteEvent('${e.id}')" style="padding:4px 11px;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25);border-radius:6px;color:var(--red);cursor:pointer;font-size:12px;font-family:'Noto Sans TC',sans-serif">åˆªé™¤</button></td>
        </tr>`).join('')}
      </tbody>
    </table></div>
  `;
}

function deleteEvent(id){
  showModal('ç¢ºèªåˆªé™¤','ç¢ºå®šè¦åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚',()=>{
    events = events.filter(e=>e.id!==id);
    saveLocal(); renderEvents(); renderAdminEvents();
    callAPI({action:'deleteEvent',eventId:id}).catch(()=>{});
    toast('æ´»å‹•å·²åˆªé™¤');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadOrders(){
  const w = document.getElementById('orders-wrap');
  w.innerHTML = '<div style="padding:20px;color:var(--text3)"><span class="loading"></span>è¼‰å…¥ä¸­...</div>';
  callAPI({action:'getOrders'})
    .then(data=>{
      const orders = data.orders||[];
      if(!orders.length){
        w.innerHTML = '<div class="empty-state"><span class="ico">ğŸ“‹</span><p>ç›®å‰æ²’æœ‰è¨‚å–®è¨˜éŒ„</p></div>';
        return;
      }
      w.innerHTML = `
        <div class="otable-wrap">
        <table class="otable">
          <thead><tr><th>æ™‚é–“</th><th>ç”¨æˆ¶</th><th>å“é …</th><th>åˆè¨ˆ</th><th>æ»¿é¡å¡</th><th>æˆå“¡</th><th>å‚™æ³¨</th></tr></thead>
          <tbody>${orders.map(o=>`
            <tr>
              <td class="ot-date">${o.timestamp||''}</td>
              <td class="ot-user">${esc(o.user)}</td>
              <td class="ot-items">${(o.items||[]).map(i=>`
                ${esc(i.eventName)} â€” ${esc(i.prodName)} Ã— ${i.qty}
                ${i.currency&&i.currency!=='TWD'?`<span style="color:var(--text3);font-size:11px">[${i.currency} ${fmt(i.priceOrig*i.qty)}]</span>`:''}
              `).join('<br>')}</td>
              <td class="ot-total">NT$ ${fmt(o.subtotal||0)}</td>
              <td>${(o.cards||[]).map(()=>`<span class="ot-card">ğŸ</span>`).join('')||'â€”'}</td>
              <td>${allMembers(o.items).map(m=>`<span class="ot-mem-tag">${m}</span>`).join('')||'â€”'}</td>
              <td style="color:var(--text3);font-size:12px">${esc(o.remark||'â€”')}</td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      `;
    })
    .catch(()=>{ w.innerHTML='<div class="empty-state"><p>ç„¡æ³•è¼‰å…¥è¨‚å–®ï¼ˆè«‹ç¢ºèª API è¨­å®šï¼‰</p></div>'; });
}

function allMembers(items){
  const s=new Set();
  (items||[]).forEach(i=>(i.members||[]).forEach(m=>s.add(m)));
  return [...s];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API / UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function callAPI(data){
  if(!API_URL||API_URL==='YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') return Promise.resolve({ok:true,orders:[]});
  return fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(data)}).then(r=>r.json());
}

let _mCb = null;
function showModal(title,msg,cb){
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-msg').textContent = msg;
  _mCb = cb;
  document.getElementById('modal').classList.add('open');
}
document.getElementById('modal-ok').addEventListener('click',()=>{ if(_mCb)_mCb(); closeModal(); });
function closeModal(){ document.getElementById('modal').classList.remove('open'); _mCb=null; }

function toast(msg,type=''){
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast'+(type?' '+type:'');
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.classList.remove('show'),2800);
}
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmt(n){ return Number(n||0).toLocaleString(); }
</script>
</body>
</html>
